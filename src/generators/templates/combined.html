{% extends "base.html" %}

{% block title %}ç¾è‚¡è´¢ç»æ—¥æŠ¥ - {{ date }}{% endblock %}

{% block content %}
<div class="report-header">
    <h2 data-i18n="dailyReport">ç¾è‚¡è´¢ç»æ—¥æŠ¥</h2>
    <div class="report-date">{{ date }}</div>
</div>

<!-- Tab å¯¼èˆª -->
<div class="tab-nav">
    <button class="tab-btn active" data-tab="premarket">
        <span data-i18n="premarketSummary">ç›˜å‰å¸‚åœºæ±‡æ€»</span>
        <span class="update-badge">{{ premarket_update_time }}</span>
    </button>
    <button class="tab-btn" data-tab="options">
        <span data-i18n="optionsDaily">æœŸæƒå¸‚åœºæ—¥æŠ¥</span>
        <span class="update-badge">{{ options_update_time }}</span>
    </button>
</div>

<!-- ç›˜å‰å¸‚åœºæ±‡æ€» Tab -->
<div class="tab-content active" id="premarket">
    <!-- ä¸‰å¤§æŒ‡æ•°è¡Œæƒ… -->
    <div class="indices-widget">
        {% set indices = [
            {'symbol': 'SPY', 'name': 'S&P 500'},
            {'symbol': 'QQQ', 'name': 'Nasdaq 100'},
            {'symbol': 'DIA', 'name': 'Dow Jones'}
        ] %}
        {% for idx in indices %}
        {% set info = stock_info.get(idx.symbol, {}) %}
        <div class="index-card">
            <div class="index-name">{{ idx.name }}</div>
            <div class="index-price">${{ "%.2f"|format(info.current_price or 0) }}</div>
            <div class="index-change {% if (info.change_pct or 0) >= 0 %}positive{% else %}negative{% endif %}">
                {% if (info.change or 0) >= 0 %}+{% endif %}{{ "%.2f"|format(info.change or 0) }}
                ({% if (info.change_pct or 0) >= 0 %}+{% endif %}{{ "%.2f"|format(info.change_pct or 0) }}%)
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="report-grid">
        <!-- è´¢ç»æ—¥å† -->
        <section class="card">
            <h3 class="card-title">
                <span class="icon">ğŸ“…</span>
                <span data-i18n="todayCalendar">ä»Šæ—¥è´¢ç»æ—¥å†</span>
            </h3>
            <div class="card-content">
                {% if calendar_events %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-i18n="timeET">æ—¶é—´(ET)</th>
                            <th data-i18n="event">äº‹ä»¶</th>
                            <th data-i18n="estimate">é¢„æœŸ</th>
                            <th data-i18n="previous">å‰å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in calendar_events %}
                        <tr>
                            <td class="time">{{ event.time }}</td>
                            <td>{{ event.event }}</td>
                            <td>{{ event.estimate or '-' }}</td>
                            <td>{{ event.prev or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="no-data" data-i18n="noCalendarData">ä»Šæ—¥æ— é‡è¦ç»æµæ•°æ®å‘å¸ƒ</p>
                {% endif %}
            </div>
        </section>

        <!-- ä»Šæ—¥é‡ç‚¹è´¢æŠ¥ -->
        <section class="card">
            <h3 class="card-title">
                <span class="icon">ğŸ“Š</span>
                <span data-i18n="todayEarnings">ä»Šæ—¥é‡ç‚¹è´¢æŠ¥</span>
            </h3>
            <div class="card-content">
                {% if earnings %}
                <div class="earnings-section">
                    {% if earnings.before_market %}
                    <div class="earnings-group">
                        <h4 data-i18n="beforeMarket">ç›˜å‰å‘å¸ƒ</h4>
                        <div class="earnings-list">
                            {% for e in earnings.before_market %}
                            <span class="earnings-tag">{{ stock_with_tooltip(e.symbol, stock_info) }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% if earnings.after_market %}
                    <div class="earnings-group">
                        <h4 data-i18n="afterMarket">ç›˜åå‘å¸ƒ</h4>
                        <div class="earnings-list">
                            {% for e in earnings.after_market %}
                            <span class="earnings-tag">{{ stock_with_tooltip(e.symbol, stock_info) }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p class="no-data" data-i18n="noEarningsData">ä»Šæ—¥æ— é‡ç‚¹è´¢æŠ¥å‘å¸ƒ</p>
                {% endif %}
            </div>
        </section>

        <!-- æŠ•è¡Œè¯„çº§å˜åŒ– -->
        <section class="card full-width">
            <h3 class="card-title">
                <span class="icon">ğŸ¦</span>
                <span data-i18n="ratingChanges">æŠ•è¡Œç›®æ ‡ä»·è°ƒæ•´</span>
            </h3>
            <div class="card-content">
                {% if rating_changes %}
                <table class="data-table rating-table">
                    <thead>
                        <tr>
                            <th data-i18n="stock">è‚¡ç¥¨</th>
                            <th data-i18n="bank">æŠ•è¡Œè¯„çº§</th>
                            <th data-i18n="targetPrice">ç›®æ ‡ä»·</th>
                            <th data-i18n="upside">æ½œåœ¨æ¶¨å¹…</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rating in rating_changes %}
                        <tr>
                            <td class="rating-symbol">{{ stock_with_tooltip(rating.symbol, stock_info) }}</td>
                            <td class="rating-firms">
                                {% for firm in rating.firms %}
                                <div class="firm-row {% if firm.action == 'up' %}row-bullish{% elif firm.action == 'down' %}row-bearish{% elif firm.action == 'reit' %}row-reit{% elif firm.action == 'main' %}row-maintain{% elif firm.action == 'init' %}row-init{% endif %}">
                                    <span class="firm-name">{{ firm.company }}</span>
                                    <span class="firm-grade">
                                        {% if firm.to_grade and firm.from_grade %}
                                            {% if firm.action == 'up' %}
                                            <span class="upgrade">{{ firm.from_grade }} â†’ {{ firm.to_grade }}</span>
                                            {% elif firm.action == 'down' %}
                                            <span class="downgrade">{{ firm.from_grade }} â†’ {{ firm.to_grade }}</span>
                                            {% else %}
                                            {{ firm.from_grade }} â†’ {{ firm.to_grade }}
                                            {% endif %}
                                        {% else %}
                                            {{ firm.to_grade or '-' }}
                                        {% endif %}
                                    </span>
                                </div>
                                {% endfor %}
                            </td>
                            <td>
                                {% if rating.target_mean %}
                                ${{ "%.2f"|format(rating.target_mean) }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if rating.upside_pct %}
                                    {% if rating.upside_pct > 0 %}
                                    <span class="upgrade">+{{ "%.1f"|format(rating.upside_pct) }}%</span>
                                    {% else %}
                                    <span class="downgrade">{{ "%.1f"|format(rating.upside_pct) }}%</span>
                                    {% endif %}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="rating-legend">
                    <span class="legend-item"><span class="legend-color bullish"></span><span data-i18n="upgrade">ä¸Šè°ƒ</span></span>
                    <span class="legend-item"><span class="legend-color bearish"></span><span data-i18n="downgrade">ä¸‹è°ƒ</span></span>
                    <span class="legend-item"><span class="legend-color reit"></span><span data-i18n="reiterate">é‡ç”³</span></span>
                    <span class="legend-item"><span class="legend-color maintain"></span><span data-i18n="maintain">ç»´æŒ</span></span>
                    <span class="legend-item"><span class="legend-color init"></span><span data-i18n="initiate">é¦–äºˆè¯„çº§</span></span>
                </div>
                {% else %}
                <p class="no-data" data-i18n="noRatingData">ä»Šæ—¥æ— è¯„çº§å˜åŒ–</p>
                {% endif %}
            </div>
        </section>

        <!-- æ ¸å¿ƒæ–°é—» -->
        <section class="card">
            <h3 class="card-title">
                <span class="icon">ğŸ“°</span>
                <span data-i18n="coreNews">æ ¸å¿ƒæ–°é—»</span>
            </h3>
            <div class="card-content">
                {% if core_news %}
                <ul class="news-list">
                    {% for news in core_news %}
                    <li class="news-item">
                        <span class="news-tag" data-zh="{{ news.tag }}" data-en="{{ news.tag_en or news.tag }}">{{ news.tag }}</span>
                        <span class="news-text" data-zh="{{ news.summary }}" data-en="{{ news.summary_en or news.summary }}">{{ news.summary }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="no-data" data-i18n="noCoreNews">æš‚æ— æ ¸å¿ƒæ–°é—»</p>
                {% endif %}
            </div>
        </section>

        <!-- é‡ç‚¹å…³æ³¨é¢†åŸŸ -->
        <section class="card">
            <h3 class="card-title">
                <span class="icon">ğŸ¯</span>
                <span data-i18n="focusAreas">ä»Šæ—¥é‡ç‚¹å…³æ³¨é¢†åŸŸ</span>
            </h3>
            <div class="card-content">
                {% if focus_areas %}
                <div class="focus-areas">
                    {% for area in focus_areas %}
                    <div class="focus-item">
                        <div class="focus-title" data-zh="{{ area.title }}" data-en="{{ area.title_en or area.title }}">{{ area.title }}</div>
                        <div class="focus-reason" data-zh="{{ area.reason }}" data-en="{{ area.reason_en or area.reason }}">{{ area.reason }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="no-data" data-i18n="noFocusAreas">æš‚æ— é‡ç‚¹å…³æ³¨é¢†åŸŸ</p>
                {% endif %}
            </div>
        </section>
    </div>
</div>

<!-- æœŸæƒå¸‚åœºæ—¥æŠ¥ Tab -->
<div class="tab-content" id="options">
    <div class="report-grid">
        <!-- å¸‚åœºæ¦‚è§ˆ -->
        <section class="card">
            <h3 class="card-title">
                <span class="icon">ğŸ“ˆ</span>
                <span data-i18n="marketOverview">å¸‚åœºæ¦‚è§ˆ</span>
            </h3>
            <div class="card-content">
                <div class="market-overview">
                    <div class="stat-item">
                        <span class="stat-label" data-i18n="totalVolume">å…¨å¸‚åœºæˆäº¤é‡</span>
                        <span class="stat-value">{{ "{:,}".format(market_overview.total_volume or 0) }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label" data-i18n="callVolume">çœ‹æ¶¨æœŸæƒæˆäº¤</span>
                        <span class="stat-value call">{{ "{:,}".format(market_overview.total_call_volume or 0) }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label" data-i18n="putVolume">çœ‹è·ŒæœŸæƒæˆäº¤</span>
                        <span class="stat-value put">{{ "{:,}".format(market_overview.total_put_volume or 0) }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label" data-i18n="pcRatio">P/C æ¯”ç‡</span>
                        <span class="stat-value">{{ market_overview.pc_ratio or '-' }}</span>
                    </div>
                    <div class="stat-item highlight">
                        <span class="stat-label" data-i18n="sentiment">å¸‚åœºæƒ…ç»ª</span>
                        {% set sentiment_en_map = {'æåº¦çœ‹æ¶¨': 'Extremely Bullish', 'çœ‹æ¶¨': 'Bullish', 'ä¸­æ€§': 'Neutral', 'çœ‹è·Œ': 'Bearish', 'æåº¦çœ‹è·Œ': 'Extremely Bearish'} %}
                        <span class="stat-value sentiment {{ market_overview.sentiment_class or '' }}" data-zh="{{ market_overview.sentiment or '-' }}" data-en="{{ sentiment_en_map.get(market_overview.sentiment, market_overview.sentiment) or '-' }}">{{ market_overview.sentiment or '-' }}</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- æŒ‡æ•°æœŸæƒçœ‹æ¶¨çœ‹è·Œå æ¯” -->
        <section class="card">
            <h3 class="card-title">
                <span class="icon">ğŸ“Š</span>
                <span data-i18n="indexCallPut">æŒ‡æ•°æœŸæƒ Call/Put å æ¯”</span>
            </h3>
            <div class="card-content">
                {% for idx in index_options %}
                <div class="cp-bar-container">
                    <span class="cp-symbol">{{ stock_with_tooltip(idx.symbol, stock_info) }}</span>
                    <div class="cp-bar">
                        <div class="cp-call" style="width: {{ idx.call_pct }}%">
                            <span>{{ idx.call_pct }}%</span>
                        </div>
                        <div class="cp-put" style="width: {{ idx.put_pct }}%">
                            <span>{{ idx.put_pct }}%</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <div class="cp-legend">
                    <span class="legend-call">â–  Call</span>
                    <span class="legend-put">â–  Put</span>
                </div>
            </div>
        </section>

        <!-- æŒ‡æ•°æœŸæƒæˆäº¤é‡ TOP 5 -->
        <section class="card">
            <h3 class="card-title">
                <span class="icon">ğŸ†</span>
                <span data-i18n="indexTop5">æŒ‡æ•°æœŸæƒæˆäº¤é‡ TOP 5</span>
            </h3>
            <div class="card-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-i18n="index">æŒ‡æ•°</th>
                            <th data-i18n="total">æ€»æˆäº¤</th>
                            <th>Call</th>
                            <th>Put</th>
                            <th data-i18n="pcRatio">P/Cæ¯”</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for idx in index_options %}
                        <tr class="{% if idx.pc_ratio > 1 %}row-bearish{% elif idx.pc_ratio < 1 %}row-bullish{% endif %}">
                            <td>{{ stock_with_tooltip(idx.symbol, stock_info) }}</td>
                            <td>{{ "{:,}".format(idx.total_volume) }}</td>
                            <td class="call">{{ "{:,}".format(idx.call_volume) }}</td>
                            <td class="put">{{ "{:,}".format(idx.put_volume) }}</td>
                            <td>{{ idx.pc_ratio }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <!-- VIX ææ…ŒæŒ‡æ•° -->
        <section class="card">
            <h3 class="card-title">
                <span class="icon">ğŸ˜±</span>
                <span data-i18n="fearIndex">ææ…ŒæŒ‡æ•° VIX</span>
            </h3>
            <div class="card-content">
                {% set vix = stock_info.get('^VIX', {}) %}
                <div class="vix-widget">
                    <div class="vix-value {% if (vix.current_price or 0) >= 30 %}vix-high{% elif (vix.current_price or 0) >= 20 %}vix-medium{% else %}vix-low{% endif %}">
                        {{ "%.2f"|format(vix.current_price or 0) }}
                    </div>
                    <div class="vix-change {% if (vix.change or 0) >= 0 %}positive{% else %}negative{% endif %}">
                        {% if (vix.change or 0) >= 0 %}+{% endif %}{{ "%.2f"|format(vix.change or 0) }}
                        ({% if (vix.change_pct or 0) >= 0 %}+{% endif %}{{ "%.2f"|format(vix.change_pct or 0) }}%)
                    </div>
                    <div class="vix-status">
                        {% if (vix.current_price or 0) >= 30 %}
                        <span class="status-high" data-i18n="vixHigh">æåº¦ææ…Œ</span>
                        {% elif (vix.current_price or 0) >= 20 %}
                        <span class="status-medium" data-i18n="vixMedium">ææ…Œ</span>
                        {% else %}
                        <span class="status-low" data-i18n="vixLow">å¹³é™</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

        <!-- ä¸ªè‚¡æœŸæƒæˆäº¤é‡ TOP 25 -->
        <section class="card full-width">
            <h3 class="card-title">
                <span class="icon">ğŸ”¥</span>
                <span data-i18n="stockTop25">ä¸ªè‚¡æœŸæƒæˆäº¤é‡ TOP 25</span>
            </h3>
            <div class="card-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th data-i18n="rank">#</th>
                            <th data-i18n="stock">è‚¡ç¥¨</th>
                            <th data-i18n="total">æ€»æˆäº¤</th>
                            <th>Call</th>
                            <th>Put</th>
                            <th data-i18n="pcRatio">P/Cæ¯”</th>
                            <th data-i18n="hottestOption">æœ€çƒ­æœŸæƒ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stock in top_25_stocks %}
                        <tr class="{% if stock.pc_ratio > 1 %}row-bearish{% elif stock.pc_ratio < 1 %}row-bullish{% endif %}">
                            <td>{{ loop.index }}</td>
                            <td>{{ stock_with_tooltip(stock.symbol, stock_info) }}</td>
                            <td>{{ "{:,}".format(stock.total_volume) }}</td>
                            <td class="call">{{ "{:,}".format(stock.call_volume) }}</td>
                            <td class="put">{{ "{:,}".format(stock.put_volume) }}</td>
                            <td>{{ stock.pc_ratio }}</td>
                            <td class="hottest">{{ stock.hottest_option }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>
</div>

<script>
// Tab åˆ‡æ¢é€»è¾‘
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        // ç§»é™¤æ‰€æœ‰ active çŠ¶æ€
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        // æ·»åŠ å½“å‰ active çŠ¶æ€
        btn.classList.add('active');
        const tabId = btn.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');

        // ä¿å­˜åˆ° localStorage
        localStorage.setItem('activeTab', tabId);
    });
});

// æ¢å¤ä¸Šæ¬¡é€‰ä¸­çš„ tab
const savedTab = localStorage.getItem('activeTab');
if (savedTab) {
    const btn = document.querySelector(`.tab-btn[data-tab="${savedTab}"]`);
    if (btn) btn.click();
}
</script>
{% endblock %}
