{% extends "base.html" %}
{% from "base.html" import stock_with_tooltip %}

{% block title %}ç›˜å‰å¸‚åœºæ±‡æ€» - {{ date }}{% endblock %}

{% block content %}
<div class="report-header">
    <h2>ç›˜å‰å¸‚åœºæ±‡æ€»</h2>
    <div class="report-date">{{ date }}</div>
</div>

<div class="report-grid">
    <!-- ä»Šæ—¥è´¢ç»æ—¥å† -->
    <section class="card">
        <h3 class="card-title">
            <span class="icon">ğŸ“…</span>
            ä»Šæ—¥è´¢ç»æ—¥å†
        </h3>
        <div class="card-content">
            {% if calendar_events %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>äº‹ä»¶</th>
                        <th>é¢„æœŸ</th>
                        <th>å‰å€¼</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in calendar_events %}
                    <tr>
                        <td class="time">{{ event.time }}</td>
                        <td>{{ event.event }}</td>
                        <td>{{ event.estimate or '-' }}</td>
                        <td>{{ event.prev or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">ä»Šæ—¥æ— é‡è¦ç»æµæ•°æ®å‘å¸ƒ</p>
            {% endif %}
        </div>
    </section>

    <!-- ä»Šæ—¥é‡ç‚¹è´¢æŠ¥ -->
    <section class="card">
        <h3 class="card-title">
            <span class="icon">ğŸ“Š</span>
            ä»Šæ—¥é‡ç‚¹è´¢æŠ¥
        </h3>
        <div class="card-content">
            {% if earnings %}
            <div class="earnings-section">
                {% if earnings.before_market %}
                <div class="earnings-group">
                    <h4>ç›˜å‰å‘å¸ƒ</h4>
                    <div class="earnings-list">
                        {% for e in earnings.before_market %}
                        <span class="earnings-tag">{{ stock_with_tooltip(e.symbol, stock_info) }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% if earnings.after_market %}
                <div class="earnings-group">
                    <h4>ç›˜åå‘å¸ƒ</h4>
                    <div class="earnings-list">
                        {% for e in earnings.after_market %}
                        <span class="earnings-tag">{{ stock_with_tooltip(e.symbol, stock_info) }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <p class="no-data">ä»Šæ—¥æ— é‡è¦è´¢æŠ¥å‘å¸ƒ</p>
            {% endif %}
        </div>
    </section>

    <!-- æŠ•è¡Œç›®æ ‡ä»·è°ƒæ•´ -->
    <section class="card">
        <h3 class="card-title">
            <span class="icon">ğŸ¯</span>
            æŠ•è¡Œç›®æ ‡ä»·è°ƒæ•´
        </h3>
        <div class="card-content">
            {% if rating_changes %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>è‚¡ç¥¨</th>
                        <th>æŠ•è¡Œ</th>
                        <th>è¯„çº§</th>
                        <th>ç›®æ ‡ä»·</th>
                        <th>æ½œåœ¨æ¶¨å¹…</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in rating_changes %}
                    <tr>
                        <td>{{ stock_with_tooltip(r.symbol, stock_info) }}</td>
                        <td>{{ r.company }}</td>
                        <td class="action {{ 'upgrade' if r.action == 'up' else 'downgrade' if r.action == 'down' else '' }}">
                            {{ r.to_grade }}
                        </td>
                        <td>${{ "%.0f"|format(r.target_mean) if r.target_mean else '-' }}</td>
                        <td class="{{ 'upgrade' if r.upside_pct and r.upside_pct > 0 else 'downgrade' if r.upside_pct and r.upside_pct < 0 else '' }}">
                            {{ "+%.1f%%"|format(r.upside_pct) if r.upside_pct and r.upside_pct > 0 else "%.1f%%"|format(r.upside_pct) if r.upside_pct else '-' }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">æš‚æ— æœ€æ–°è¯„çº§å˜åŒ–</p>
            {% endif %}
        </div>
    </section>

    <!-- ä»Šæ—¥æ ¸å¿ƒå¸‚åœºæ–°é—» -->
    <section class="card full-width">
        <h3 class="card-title">
            <span class="icon">ğŸ“°</span>
            ä»Šæ—¥æ ¸å¿ƒå¸‚åœºæ–°é—»
        </h3>
        <div class="card-content">
            {% if core_news %}
            <ol class="news-list">
                {% for news in core_news %}
                <li class="news-item">
                    <span class="news-tag">{{ news.tag }}</span>
                    <span class="news-text">{{ news.summary }}</span>
                </li>
                {% endfor %}
            </ol>
            {% else %}
            <p class="no-data">æ­£åœ¨åˆ†ææ–°é—»æ•°æ®...</p>
            {% endif %}
        </div>
    </section>

    <!-- ä»Šæ—¥é‡ç‚¹å…³æ³¨é¢†åŸŸ -->
    <section class="card full-width">
        <h3 class="card-title">
            <span class="icon">ğŸ”</span>
            ä»Šæ—¥é‡ç‚¹å…³æ³¨é¢†åŸŸ
        </h3>
        <div class="card-content">
            {% if focus_areas %}
            <div class="focus-areas">
                {% for area in focus_areas %}
                <div class="focus-item">
                    <h4 class="focus-title">{{ area.sector }}</h4>
                    <p class="focus-reason">{{ area.reason }}</p>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="no-data">æ­£åœ¨åˆ†æé‡ç‚¹å…³æ³¨é¢†åŸŸ...</p>
            {% endif %}
        </div>
    </section>
</div>
{% endblock %}
